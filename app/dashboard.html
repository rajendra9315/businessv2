<!DOCTYPE html>
<html>
<head>
  <title>Dashboard | Smart Business Analytics</title>
  <link rel="stylesheet" href="../public/assets/style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
<script>protectPage();</script>

<header>
  <h1>Smart Business Analytics</h1>
  <nav>
    <a href="dashboard.html" class="active">Dashboard</a>
    <a href="upload.html">Upload</a>
    <a href="profile.html">Profile</a>
    <a href="#" onclick="logoutUser()">Logout</a>
  </nav>
</header>

<div class="container">

  <!-- HEADER -->
  <div style="margin-bottom:30px;">
    <h2>Dashboard</h2>
    <p style="color:#6b7280;">
      High-level overview of revenue, profit and growth.
    </p>
  </div>

  <!-- KPI SECTION -->
  <h3>Key Metrics</h3>
  <div class="dashboard-grid" style="margin-top:30px;">
    <div class="kpi">
      <h4>Total Revenue</h4>
      <p id="revenue">‚Çπ 0</p>
    </div>

    <div class="kpi">
      <h4>Total Profit</h4>
      <p id="profit">‚Çπ 0</p>
    </div>

    <div class="kpi">
      <h4>Profit Margin</h4>
      <p id="margin">0 %</p>
    </div>

    <div class="kpi">
      <h4>Growth</h4>
      <p id="growth">0 %</p>
    </div>
  </div>

  <!-- CHARTS -->
  <div id="chartsSection">
    <h3 style="margin-top:40px;">Performance Charts</h3>

    <div class="cards">
      <div class="card">
        <h3>üìà Revenue Trend</h3>
        <canvas id="revenueChart"></canvas>
      </div>

      <div class="card">
        <h3>üìä Profit by Product</h3>
        <canvas id="profitChart"></canvas>
      </div>

      <div class="card">
        <h3>ü•ß Cost Breakdown</h3>
        <canvas id="costChart"></canvas>
      </div>
    </div>
  </div>

  <!-- INSIGHTS -->
  <h3 style="margin-top:40px;">Insights & Opportunities</h3>

  <div class="cards" style="margin-top:40px;">
    <div class="card">
      <h3>üß† AI Insight</h3>
      <p id="aiInsight">Insights will appear after analysis.</p>
    </div>

    <div class="card">
      <h3>‚ö†Ô∏è Risks</h3>
      <p id="riskInsight">Risks will appear here.</p>
    </div>

    <div class="card">
      <h3>üöÄ Opportunities</h3>
      <p id="opportunityInsight">Opportunities will appear here.</p>
    </div>
  </div>

</div>

<!-- GLOBAL JS -->
<script src="../public/assets/app.js"></script>

<!-- DASHBOARD LOGIC -->
<script>
  const results = JSON.parse(localStorage.getItem("analysisResults"));

  if (!results) {
    alert("No analysis found. Upload data first.");
    window.location.href = "upload.html";
  }

  /* ===== KPIs ===== */
  document.getElementById("revenue").innerText =
    "‚Çπ " + results.kpis.revenue.toLocaleString();

  document.getElementById("profit").innerText =
    "‚Çπ " + results.kpis.profit.toLocaleString();

  document.getElementById("margin").innerText =
    results.kpis.margin + " %";

  document.getElementById("growth").innerText =
    results.kpis.growth + " %";

  /* ===== ADMIN CONTROL ===== */
  const adminSettings = JSON.parse(localStorage.getItem("adminSettings"));
  if (adminSettings && adminSettings.chartsEnabled === false) {
    document.getElementById("chartsSection").style.display = "none";
  }

  /* ===== CHARTS ===== */
  const charts = results.charts;

  // Revenue Trend
  new Chart(document.getElementById("revenueChart"), {
    type: "line",
    data: {
      labels: charts.revenue_trend.labels,
      datasets: [{
        label: "Revenue (‚Çπ)",
        data: charts.revenue_trend.data,
        borderColor: "#2563eb",
        backgroundColor: "rgba(37,99,235,0.1)",
        fill: true,
        tension: 0.4
      }]
    }
  });

  // Profit by Product
  if (charts.profit_by_product.labels.length) {
    new Chart(document.getElementById("profitChart"), {
      type: "bar",
      data: {
        labels: charts.profit_by_product.labels,
        datasets: [{
          label: "Profit (‚Çπ)",
          data: charts.profit_by_product.data,
          backgroundColor: "#22c55e"
        }]
      }
    });
  }

  // Cost Breakdown
  if (charts.cost_breakdown.labels.length) {
    new Chart(document.getElementById("costChart"), {
      type: "pie",
      data: {
        labels: charts.cost_breakdown.labels,
        datasets: [{
          data: charts.cost_breakdown.data,
          backgroundColor: ["#f97316", "#ef4444", "#3b82f6"]
        }]
      }
    });
  }
</script>

</body>
</html>
